<!DOCTYPE html>
<html>
<head>
    <title>EMDRGB</title>
    <style>
        body { font-family: Arial; text-align: center; margin-top: 50px; }
        #colorPicker { margin: 20px; width: 100px; height: 100px; }
        button { padding: 10px 20px; font-size: 16px; }
        #status { color: red; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>EMD<font color="#f00">R</font><font color="#0f0">G</font><font color="#00f">B</font></h1>
    <input type="color" id="colorPicker" value="#ff0000" disabled>
    <br>
    <button id="connectBtn">Connect to ESP32</button>
    <div id="status"></div>

    <script>
        const colorPicker = document.getElementById('colorPicker');
        const connectBtn = document.getElementById('connectBtn');
        const statusDiv = document.getElementById('status');
        
        // Service UUIDs (must match ESP32 code)
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';

        connectBtn.addEventListener('click', async () => {
            try {
                statusDiv.textContent = 'Searching for device...';
                statusDiv.style.color = 'black';
                
                // Request device with service UUID explicitly listed
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32-LED-Control' }],
                    optionalServices: [SERVICE_UUID]  // <<-- CRITICAL FIX
                });
                
                statusDiv.textContent = 'Connecting...';
                const server = await device.gatt.connect();
                
                statusDiv.textContent = 'Accessing service...';
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                statusDiv.textContent = 'Accessing characteristic...';
                const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                
                // Enable controls
                colorPicker.disabled = false;
                connectBtn.textContent = 'Connected!';
                connectBtn.style.backgroundColor = '#4CAF50';
                statusDiv.textContent = 'Ready! Change color below:';
                statusDiv.style.color = 'green';
                
                // Send color updates
                colorPicker.addEventListener('input', () => {
                    const hex = colorPicker.value.slice(1); // Remove #
                    const rgb = [
                        parseInt(hex.substr(0, 2), 16),
                        parseInt(hex.substr(2, 2), 16),
                        parseInt(hex.substr(4, 2), 16)
                    ];
                    characteristic.writeValue(new Uint8Array(rgb));
                });
                
                // Send initial color
                colorPicker.dispatchEvent(new Event('input'));
                
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.style.color = 'red';
                console.error('Bluetooth error:', error);
            }
        });

        // Check for Web Bluetooth support
        if (!navigator.bluetooth) {
            statusDiv.textContent = 'Web Bluetooth not supported. Use Chrome/Edge on desktop or Android.';
        }
    </script>
    v1
</body>
</html>